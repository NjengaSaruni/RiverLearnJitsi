# RiverLearn Course Organizer - Jitsi Meet Custom Configuration

# Allow embedding from Course Organizer app domain
add_header Content-Security-Policy "frame-ancestors 'self' https://co.riverlearn.co.ke" always;

# Security headers
add_header X-Content-Type-Options nosniff always;
add_header X-Frame-Options SAMEORIGIN always;
add_header Referrer-Policy "strict-origin-when-cross-origin" always;

# Force-hide watermark assets and disable caching
location = /images/watermark.svg {
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    return 204;
}

# In case some versions use PNG fallback
location = /images/watermark.png {
    add_header Cache-Control "no-store, no-cache, must-revalidate, max-age=0" always;
    add_header Pragma "no-cache" always;
    return 204;
}

# Serve RiverLearn theme CSS with proper headers
location = /css/riverlearn-theme.css {
    add_header Content-Type "text/css" always;
    add_header Cache-Control "public, max-age=3600" always;
    add_header Access-Control-Allow-Origin "*" always;
}

# Alternative CSS path for compatibility
location = /riverlearn-theme.css {
    add_header Content-Type "text/css" always;
    add_header Cache-Control "public, max-age=3600" always;
    add_header Access-Control-Allow-Origin "*" always;
}

# Serve RiverLearn branding script
location = /riverlearn-branding.js {
    add_header Content-Type "application/javascript" always;
    add_header Cache-Control "public, max-age=3600" always;
    add_header Access-Control-Allow-Origin "*" always;
}

# Alternative JS path for compatibility
location = /js/riverlearn-branding.js {
    add_header Content-Type "application/javascript" always;
    add_header Cache-Control "public, max-age=3600" always;
    add_header Access-Control-Allow-Origin "*" always;
}

# Block access to Jitsi branding assets
location ~ ^/(images|logos)/(jitsi|meet|brand|powered) {
    return 404;
}

# Block access to default config files that might override our custom ones
location = /config.js.bak {
    return 404;
}

location = /interface_config.js.bak {
    return 404;
}

# Ensure XMPP endpoints are reachable over HTTPS
location = /http-bind {
    proxy_pass http://prosody:5280/http-bind;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header Host $http_host;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_buffering off;
    client_max_body_size 0;
    add_header Access-Control-Allow-Origin "*" always;
}

location /xmpp-websocket {
    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_pass http://prosody:5280/xmpp-websocket;
    proxy_read_timeout 86400;
    add_header Access-Control-Allow-Origin "*" always;
}
